<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QoreLogic Launcher</title>
    <style>
      :root {
        /* Branding: Deep Navy & True Amber */
        --bg-primary: #000205;
        --bg-secondary: #030a17;
        --bg-card: rgba(8, 18, 36, 0.85);
        --text-primary: #e6f1ff;
        --text-secondary: #8892b0;
        --accent-primary: #ffb300;
        --accent-hover: #ff8f00;
        --accent-glow: rgba(255, 179, 0, 0.2);
        --border-subtle: rgba(136, 146, 176, 0.2);
        --font-sans: "Segoe UI", system-ui, sans-serif;
        --font-mono: "Consolas", monospace;
      }

      body {
        margin: 0;
        font-family: var(--font-sans);
        background-color: var(--bg-primary);
        color: var(--text-primary);
        height: 100vh;
        overflow: hidden;
        display: grid;
        grid-template-columns: 350px 1fr;
      }

      /* Sidebar */
      .sidebar {
        background-color: var(--bg-secondary);
        border-right: 1px solid var(--border-subtle);
        padding: 40px 24px;
        display: flex;
        flex-direction: column;
      }

      .logo {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 48px;
      }

      .logo span {
        color: var(--accent-primary);
      }

      .nav-item {
        padding: 16px;
        margin-bottom: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-secondary);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .nav-item:hover,
      .nav-item.active {
        background: rgba(255, 179, 0, 0.1);
        color: var(--accent-primary);
      }

      .nav-item.active {
        border-left: 3px solid var(--accent-primary);
      }

      /* Main Content */
      .main {
        padding: 60px;
        overflow-y: auto;
        background: radial-gradient(
          circle at top right,
          rgba(255, 179, 0, 0.05),
          transparent 40%
        );
      }

      h1 {
        margin-top: 0;
        font-size: 32px;
        letter-spacing: -0.5px;
      }
      p {
        color: var(--text-secondary);
        line-height: 1.6;
        max-width: 600px;
      }

      .card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 32px;
        margin-top: 32px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        max-width: 700px;
      }

      .input-group {
        margin-bottom: 24px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-secondary);
        font-size: 14px;
      }

      input[type="text"],
      select {
        width: 100%;
        background: rgba(255, 255, 255, 0.07); /* Lighter background for contrast */
        border: 1px solid rgba(136, 146, 176, 0.4); /* Stronger border */
        padding: 12px;
        border-radius: 6px;
        color: #fff; /* Pure white text */
        font-family: var(--font-mono);
        font-size: 14px;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 2px var(--accent-glow);
        background: rgba(255, 255, 255, 0.12);
      }
      
      /* Fix for dropdown options on dark backgrounds (Windows/Chrome specific) */
      select option {
          background-color: var(--bg-secondary);
          color: var(--text-primary);
      }

      button.primary {
        background: var(--accent-primary);
        color: #000;
        border: none;
        padding: 14px 28px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      button.primary:hover {
        background: var(--accent-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px var(--accent-glow);
      }

      button.primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        margin-bottom: 24px;
      }

      .status-indicator.offline {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
      }

      #console-output {
        background: #000;
        color: var(--text-secondary);
        font-family: var(--font-mono);
        padding: 16px;
        border-radius: 8px;
        margin-top: 24px;
        height: 150px;
        overflow-y: auto;
        font-size: 12px;
        border: 1px solid var(--border-subtle);
        display: none;
      }
    </style>
    <script>
        // Automatic Redirection for file:// usage
        // This ensures the user gets the served (functional) version instantly.
        if (window.location.protocol === 'file:') {
            // First check if server is up to avoid dead page
            fetch('http://localhost:5500/api/health')
                .then(() => {
                    window.location.href = 'http://localhost:5500/Launcher.html';
                })
                .catch(() => {
                    console.warn("Server not reachable yet. Please run Launch_QoreLogic.bat");
                    // We stay here and show the error message in the UI eventually
                });
        }
    </script>
  </head>
  <body>
    <div class="sidebar">
      <div class="logo"><span>‚¨¢</span> QoreLogic</div>
      <div class="nav-item active" onclick="showTab('launch')">üöÄ Launcher</div>
      <div class="nav-item" onclick="showTab('agents')">üß† Agents & AI</div>
      <div class="nav-item" onclick="showTab('performance')">üìä Performance</div>
      <div class="nav-item" onclick="showTab('config')">‚öôÔ∏è Configuration</div>
    </div>

    <!-- LAUNCHER TAB -->
    <div class="main tab-content" id="tab-launch">
      <div class="status-indicator offline" id="docker-status">
        ‚óè Docker Disconnected
      </div>
      <h1>Command Center</h1>
      <p>
        Initialize the sterile QoreLogic Sovereign Gatekeeper environment. 
      </p>

      <div class="card" id="launcher-card">
        <!-- Initial Launch Mode -->
        <div id="launch-mode">
            <div class="input-group">
                <label>System Root (Project Container)</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="target-path" placeholder="C:\Projects" />
                    <button onclick="browseFolder('target-path')" style="padding:10px; background:#333; color:#fff; border:1px solid #555; cursor:pointer;">üìÇ</button>
                </div>
                 <div style="font-size: 12px; color: #666; margin-top: 4px;">
                    Select the parent directory containing your projects. This will be mounted as /source.
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 32px;">
                <button class="primary" onclick="launchSystem()" id="launch-btn" style="flex: 1;">
                  <span>INITIALIZE SYSTEM</span>
                </button>
            </div>
        </div>
        
        <!-- Active System Mode -->
        <div id="active-mode" style="display:none;">
             <div class="status-indicator" style="width:100%; box-sizing:border-box; text-align:center; margin-bottom:20px;">
                ‚úÖ QoreLogic Engine Active
            </div>
            
            <div class="input-group">
                <label>Active Workspace</label>
                <div style="display:flex; gap:10px;">
                    <select id="workspace-select" onchange="switchWorkspace()">
                        <option value="default">Default Workspace</option>
                    </select>
                    <button onclick="showCreateWorkspace()" style="padding:10px; background:#333; color:#fff; border:1px solid #555; cursor:pointer;" title="New Workspace">‚ûï</button>
                </div>
            </div>
            
            <div id="create-workspace-panel" style="display:none; margin-top:15px; background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                 <label>New Workspace Name</label>
                 <div style="display:flex; gap:10px;">
                    <input type="text" id="new-ws-name" placeholder="Project Alpha" />
                    <button class="primary" onclick="createNewWorkspace()" style="padding:10px;">Create</button>
                 </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 32px;">
                <button class="primary" onclick="openDashboard()" style="flex: 1; background:#10b981;">
                  <span>OPEN DASHBOARD</span>
                </button>
        
                <button class="primary" onclick="stopSystem()" id="stop-btn" style="background: #ef4444; flex: 1;">
                  <span>STOP SYSTEM</span>
                </button>
            </div>
        </div>

        <div id="console-output"></div>
      </div>
    </div>

    <!-- AGENTS TAB -->
    <!-- AGENTS TAB -->
    <div class="main tab-content" id="tab-agents" style="display:none;">
        <h1>Agent Configuration</h1>
        <p>Configure the cognitive architecture and persona directives.</p>
        
        <!-- Global LLM Settings -->
        <div class="card">
            <h3>LLM Backend Connection</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                 <div class="input-group">
                    <label>Provider</label>
                    <select id="llm-provider" onchange="toggleProviderSettings()">
                        <option value="ollama">Ollama (Local)</option>
                        <option value="openai">OpenAI (API)</option>
                        <option value="anthropic">Anthropic (API)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Base URL</label>
                    <input type="text" id="llm-endpoint" value="http://localhost:11434" />
                </div>
            </div>
            
            <div id="ollama-controls" style="margin-top:10px;">
                <button class="primary" onclick="refreshModels()" style="padding: 8px 16px; font-size:12px; background:#333; border:1px solid #555;">
                   üîÑ Discover Local Models
                </button>
                <div style="display:inline-block; font-size:12px; color:#aaa; margin-left:10px;" id="model-status"></div>
            </div>
        </div>

        <!-- Agent Personalities -->
        <div class="card">
            <h3>Agent Assignment & Directives</h3>
            <p style="font-size:12px; color:#888; margin-bottom:20px;">Assign specific models and prompts to each cognitive role.</p>
            
            <!-- Sentinel -->
            <div style="border-bottom:1px solid #333; padding-bottom:20px; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="color:var(--accent-primary); font-weight:bold;">üõ°Ô∏è Sentinel (Security Auditor)</label>
                    <select class="model-selector" id="model-sentinel" style="width:200px;">
                         <option value="default">Default (System)</option>
                    </select>
                </div>
                <textarea id="prompt-sentinel" rows="3" style="width:100%; margin-top:8px; background:rgba(0,0,0,0.3); color:#ccc; border:1px solid #333; padding:8px; border-radius:6px; font-family:var(--font-mono); font-size:12px;">You are SENTINEL, a static analysis expert...</textarea>
            </div>

            <!-- Judge -->
             <div style="border-bottom:1px solid #333; padding-bottom:20px; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="color:var(--accent-primary); font-weight:bold;">‚öñÔ∏è Judge (Compliance Verifier)</label>
                    <select class="model-selector" id="model-judge" style="width:200px;">
                         <option value="default">Default (System)</option>
                    </select>
                </div>
                <textarea id="prompt-judge" rows="3" style="width:100%; margin-top:8px; background:rgba(0,0,0,0.3); color:#ccc; border:1px solid #333; padding:8px; border-radius:6px; font-family:var(--font-mono); font-size:12px;">You are JUDGE, the final arbiter of code compliance...</textarea>
            </div>
            
            <!-- Overseer -->
             <div style="border-bottom:1px solid #333; padding-bottom:20px; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="color:var(--accent-primary); font-weight:bold;">üëÅÔ∏è Overseer (Context)</label>
                    <select class="model-selector" id="model-overseer" style="width:200px;">
                         <option value="default">Default (System)</option>
                    </select>
                </div>
                <textarea id="prompt-overseer" rows="3" style="width:100%; margin-top:8px; background:rgba(0,0,0,0.3); color:#ccc; border:1px solid #333; padding:8px; border-radius:6px; font-family:var(--font-mono); font-size:12px;">You are OVERSEER, a project manager and strategist...</textarea>
            </div>

            <!-- Scrivener -->
            <div>
                 <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="color:var(--accent-primary); font-weight:bold;">üìù Scrivener (Documentation)</label>
                    <select class="model-selector" id="model-scrivener" style="width:200px;">
                         <option value="default">Default (System)</option>
                    </select>
                </div>
                <textarea id="prompt-scrivener" rows="3" style="width:100%; margin-top:8px; background:rgba(0,0,0,0.3); color:#ccc; border:1px solid #333; padding:8px; border-radius:6px; font-family:var(--font-mono); font-size:12px;">You are SCRIVENER, the technical documentation engine...</textarea>
            </div>

            <button class="primary" onclick="saveAgents()" style="margin-top:24px; width:100%;">Save Agent Configuration</button>
        </div>
    </div>

    <!-- PERFORMANCE TAB -->
     <div class="main tab-content" id="tab-performance" style="display:none;">
        <h1>System Performance</h1>
        <p>Real-time metrics and token economics.</p>
        
        <div class="card">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div style="text-align:center; padding:20px; background:rgba(255,255,255,0.05); border-radius:8px;">
                    <h2 id="perf-tokens" style="margin:0; color:var(--accent-primary);">0</h2>
                    <span style="color:#888;">Ledger Entries</span>
                </div>
                <div style="text-align:center; padding:20px; background:rgba(255,255,255,0.05); border-radius:8px;">
                    <h2 id="perf-mode" style="margin:0; color:#10b981;">OFFLINE</h2>
                    <span style="color:#888;">System Status</span>
                </div>
                 <div style="text-align:center; padding:20px; background:rgba(255,255,255,0.05); border-radius:8px;">
                    <h2 id="perf-memory" style="margin:0; color:#3b82f6;">-</h2>
                    <span style="color:#888;">Container Memory</span>
                </div>
                 <div style="text-align:center; padding:20px; background:rgba(255,255,255,0.05); border-radius:8px;">
                    <h2 id="perf-cost" style="margin:0; color:#f59e0b;">$0.00</h2>
                    <span style="color:#888;">Est. Cost (Local)</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CONFIG TAB -->
    <div class="main tab-content" id="tab-config" style="display:none;">
        <h1>Configuration</h1>
        <p>Global launcher settings.</p>
        <div class="card">
             <div class="input-group">
                <label>Launcher Port</label>
                <input type="text" value="5500" disabled />
             </div>
             <div class="input-group" style="margin-top:16px;">
                <label>Theme</label>
                <select disabled>
                    <option>Deep Navy (Default)</option>
                </select>
             </div>
        </div>
    </div>

    <style>
           /* Modal Styles */
           dialog {
               background: var(--bg-card);
               color: var(--text-primary);
               border: 1px solid var(--accent-primary);
               border-radius: 8px;
               padding: 24px;
               max-width: 500px;
               width: 100%;
               box-shadow: 0 20px 50px rgba(0,0,0,0.5);
               position: fixed;
               top: 50%; left: 50%; transform: translate(-50%, -50%);
           }
           dialog::backdrop {
               background: rgba(0,0,0,0.7);
           }
    </style>

    <script>
      function showTab(tabId) {
          document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
          document.getElementById('tab-' + tabId).style.display = 'block';
          
          document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
          const map = {'launch':0, 'agents':1, 'performance':2, 'config':3};
          const navItems = document.querySelectorAll('.nav-item');
          if(navItems[map[tabId]]) navItems[map[tabId]].classList.add('active');
      }

      async function checkServerStatus() {
         try {
             const res = await fetch("http://localhost:5500/api/health");
             if (res.ok) {
                 document.getElementById("docker-status").className = "status-indicator";
                 document.getElementById("docker-status").innerText = "‚óè Host Connected";
                 document.getElementById("stop-btn").style.display = "inline-flex";
             }
         } catch(e) {
             const output = document.getElementById("console-output");
             if(output) log("Launcher disconnected. Open 'Launch_QoreLogic.bat'");
         }
      }

      async function browseFolder(inputId) {
          try {
              const res = await fetch("http://localhost:5500/api/dialog/folder");
              const data = await res.json();
              if (data.path) {
                  document.getElementById(inputId).value = data.path;
              }
          } catch(e) {
              log("Browse failed: " + e);
          }
      }
      
      function toggleProviderSettings() {
          const provider = document.getElementById("llm-provider").value;
          const ollamaControls = document.getElementById("ollama-controls");
          
          if (provider === "ollama") {
              if(ollamaControls) ollamaControls.style.display = "block";
              document.getElementById("llm-endpoint").value = "http://localhost:11434";
          } else {
              if(ollamaControls) ollamaControls.style.display = "none";
              if(provider === "openai") document.getElementById("llm-endpoint").value = "https://api.openai.com/v1";
              if(provider === "anthropic") document.getElementById("llm-endpoint").value = "https://api.anthropic.com/v1";
          }
      }

      async function refreshModels() {
         const btn = document.querySelector("#ollama-controls button");
         const status = document.getElementById("model-status");
         const endpoint = document.getElementById("llm-endpoint").value;
         
         if(btn) btn.disabled = true;
         if(status) status.innerText = "Scanning...";
         
         try {
             const res = await fetch(endpoint + "/api/tags");
             if (!res.ok) throw new Error("Ollama connection failed");
             
             const data = await res.json();
             const models = data.models.map(m => m.name);
             
             // Populate all selectors
             const selectors = document.querySelectorAll(".model-selector");
             selectors.forEach(sel => {
                 const current = sel.value;
                 sel.innerHTML = '<option value="default">Default (System)</option>';
                 models.forEach(m => {
                     const opt = document.createElement("option");
                     opt.value = m;
                     opt.innerText = m;
                     sel.appendChild(opt);
                 });
                 if (models.includes(current)) sel.value = current;
             });
             
             if(status) {
                 status.innerText = `‚úÖ Found ${models.length} models`;
                 status.style.color = "#10b981";
             }
             
         } catch(e) {
             if(status) {
                 status.innerText = "‚ùå Connection Failed.";
                 status.style.color = "#ef4444";
             }
             log("Ollama Scan Error: " + e);
         }
         
         if(btn) btn.disabled = false;
      }

      async function saveAgents() {
          const config = {
              provider: document.getElementById('llm-provider').value,
              endpoint: document.getElementById('llm-endpoint').value,
              models: {
                  sentinel: document.getElementById('model-sentinel') ? document.getElementById('model-sentinel').value : 'default',
                  judge: document.getElementById('model-judge') ? document.getElementById('model-judge').value : 'default',
                  overseer: document.getElementById('model-overseer') ? document.getElementById('model-overseer').value : 'default',
                  scrivener: document.getElementById('model-scrivener') ? document.getElementById('model-scrivener').value : 'default'
              },
              prompts: {
                  sentinel: document.getElementById('prompt-sentinel').value,
                  judge: document.getElementById('prompt-judge').value,
                  overseer: document.getElementById('prompt-overseer').value,
                  scrivener: document.getElementById('prompt-scrivener').value
              }
          };
          
          const modeEl = document.getElementById('op-mode');
          const mode = modeEl ? modeEl.value : 'normal';
          
          try {
              // Save Agents
              await fetch("http://localhost:5500/api/config/agents", {
                  method: "POST",
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(config)
              });
              
              // Save Mode
              await fetch("http://localhost:5500/api/config/mode", {
                  method: "POST",
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ mode: mode, workspace: "default" })
              });

              alert("Configuration Saved!");
          } catch(e) {
              alert("Error saving: " + e);
          }
      }

      async function stopSystem() {
          const btn = document.getElementById("stop-btn");
          btn.disabled = true;
          btn.innerHTML = "STOPPING...";
          
          log("Sending stop command...");
          
          try {
             const res = await fetch("http://localhost:5500/api/stop", { method: "POST" });
             const data = await res.json();
             log(data.message);
             btn.innerHTML = "STOP SYSTEM";
             btn.disabled = false;
             
             document.getElementById("docker-status").className = "status-indicator offline";
             document.getElementById("docker-status").innerText = "‚óè Docker Stopped";
             
          } catch (e) {
             log("Error stopping: " + e);
             btn.disabled = false;
          }
      }

      async function launchSystem() {
        const btn = document.getElementById("launch-btn");
        const output = document.getElementById("console-output");
        const targetPath = document.getElementById("target-path").value;

        btn.disabled = true;
        btn.innerHTML = "STARTING CONTAINER...";
        output.style.display = "block";

        if(targetPath) {
             log(`Detailed Mode: Targeting context at ${targetPath}`);
        } else {
             log(`Quick Mode: Targeting embedded QoreLogic repo`);
        }

        try {
          const res = await fetch("http://localhost:5500/api/launch", { 
              method: "POST",
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ path: targetPath })
          });
          const data = await res.json();

          if (data.status === "ok") {
            log("Build started. Check terminal for details.");
            log("Waiting for Dashboard availability...");
            
            document.getElementById("stop-btn").style.display = "inline-flex";
            checkDashboardLoop();
          } else {
            log("Error: " + data.error);
            btn.disabled = false;
            btn.innerHTML = "INITIALIZE SYSTEM";
          }
        } catch (e) {
          log("Connection failed: " + e);
          btn.disabled = false;
        }
      }

      function log(msg) {
        const output = document.getElementById("console-output");
        output.style.display = "block";
        output.innerHTML += `<div>> ${msg}</div>`;
        output.scrollTop = output.scrollHeight;
      }
      
      // Global state
      let currentWorkspace = null;

      async function updateStats() {
          try {
              let url = "http://localhost:8000/api/status";
              if(currentWorkspace && currentWorkspace.id) {
                  url += `?ws_id=${currentWorkspace.id}`;
              }
              
              const res = await fetch(url);
              if (res.ok) {
                  const data = await res.json();
                  const elTokens = document.getElementById("perf-tokens");
                  const elMode = document.getElementById("perf-mode");
                  if(elTokens) elTokens.innerText = (data.total_ledger_entries || 0).toLocaleString();
                  if(elMode) elMode.innerText = (data.current_mode || "ONLINE").toUpperCase();
                  
                  // Mock field
                  const elMem = document.getElementById("perf-memory");
                  if(elMem) elMem.innerText = "1.2GB"; 
              }
          } catch(e) { }
      }
      
      async function refreshWorkspaces() {
          try {
              const res = await fetch("http://localhost:8000/api/workspaces");
              if(res.ok) {
                  const data = await res.json();
                  const sel = document.getElementById("workspace-select");
                  sel.innerHTML = "";
                  
                  // Active
                  if(data.active) {
                       currentWorkspace = data.workspaces[data.active];
                  }
                  
                  Object.values(data.workspaces).forEach(ws => {
                      const opt = document.createElement("option");
                      opt.value = ws.id;
                      opt.innerText = ws.name; // + ` (${ws.path})`;
                      if(data.active === ws.id) opt.selected = true;
                      sel.appendChild(opt);
                  });
              }
          } catch(e) { console.error(e); }
      }

      function showCreateWorkspace() {
          const el = document.getElementById("create-workspace-panel");
          el.style.display = el.style.display === "none" ? "block" : "none";
      }

      async function createNewWorkspace() {
          const name = document.getElementById("new-ws-name").value;
          if(!name) return;
          
          try {
              const res = await fetch("http://localhost:8000/api/workspaces", {
                  method: "POST",
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ name: name, path: "/source/" + name })
              });
              if(res.ok) {
                   await refreshWorkspaces();
                   showCreateWorkspace();
                   document.getElementById("new-ws-name").value = "";
              }
          } catch(e) { alert("Error: " + e); }
      }

      async function switchWorkspace() {
          const id = document.getElementById("workspace-select").value;
           try {
              const res = await fetch("http://localhost:8000/api/workspaces/activate", {
                  method: "POST",
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ id: id })
              });
              if(res.ok) {
                   await refreshWorkspaces();
                   updateStats(); // Refresh stats for new workspace
              }
          } catch(e) { alert("Error: " + e); }
      }
      
      function openDashboard() {
           window.open("http://localhost:8000", "_blank");
      }

      function checkDashboardLoop() {
        let attempts = 0;
        const maxAttempts = 60; 
        
        const interval = setInterval(async () => {
            attempts++;
            try {
                const res = await fetch("http://localhost:8000/api/health");
                if (res.ok) {
                    clearInterval(interval);
                    const btn = document.getElementById("launch-btn");
                    
                    log("‚úÖ QoreLogic Dashboard is ONLINE!");
                    
                    // Switch UI to Active Mode
                    document.getElementById("launch-mode").style.display = "none";
                    document.getElementById("active-mode").style.display = "block";
                    
                    document.getElementById("docker-status").innerText = "‚óè System Online";
                    document.getElementById("docker-status").className = "status-indicator";
                    
                    // Load Workspaces
                    refreshWorkspaces();
                    
                    // Poll stats every 2s
                    setInterval(updateStats, 2000);
                    updateStats();
                    
                    // Don't auto-open dashboard tab, let user decide
                    // window.open("http://localhost:8000", "_blank");
                }
            } catch (e) {
                if (attempts % 5 === 0) log("...waiting for container (" + attempts + "s)");
            }
            
            if (attempts >= maxAttempts) {
                clearInterval(interval);
                log("‚ùå Timed out waiting for Dashboard.");
                document.getElementById("launch-btn").disabled = false;
                document.getElementById("launch-btn").innerHTML = "INITIALIZE SYSTEM";
            }
        }, 1000);
      }

      // Check if Dashboard is ALREADY running (e.g. user refreshed Launcher)
      async function initialCheck() {
         try {
             const res = await fetch("http://localhost:8000/api/health");
             if(res.ok) {
                 // Already running!
                 document.getElementById("launch-mode").style.display = "none";
                 document.getElementById("active-mode").style.display = "block";
                 document.getElementById("docker-status").innerText = "‚óè System Online (Ready)";
                 document.getElementById("docker-status").className = "status-indicator";
                 
                 refreshWorkspaces();
                 setInterval(updateStats, 2000);
                 updateStats();
             } else {
                 // Not running, check launcher server
                 checkServerStatus();
             }
         } catch(e) {
             checkServerStatus();
         }
      }

      initialCheck();
    </script>
  </body>
</html>
